; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --function-signature --check-globals
; RUN: opt -S -mtriple=amdgcn-amd-amdhsa -passes=amdgpu-attributor %s | FileCheck -check-prefix=ATTRIBUTOR_GCN %s

target datalayout = "A5"

@global_ptr = local_unnamed_addr global ptr null, align 8

;.
; ATTRIBUTOR_GCN: @global_ptr = local_unnamed_addr global ptr null, align 8
;.
define void @callee1() {
; ATTRIBUTOR_GCN-LABEL: define {{[^@]+}}@callee1
; ATTRIBUTOR_GCN-SAME: () #[[ATTR0:[0-9]+]] {
; ATTRIBUTOR_GCN-NEXT:    ret void
;
  ret void
}

define void @callee2() {
; ATTRIBUTOR_GCN-LABEL: define {{[^@]+}}@callee2
; ATTRIBUTOR_GCN-SAME: () #[[ATTR0]] {
; ATTRIBUTOR_GCN-NEXT:    ret void
;
  ret void
}

define ptr @take_addr_1() {
; ATTRIBUTOR_GCN-LABEL: define {{[^@]+}}@take_addr_1
; ATTRIBUTOR_GCN-SAME: () #[[ATTR0]] {
; ATTRIBUTOR_GCN-NEXT:    ret ptr @callee1
;
  ret ptr @callee1
}

define ptr @take_addr_2() {
; ATTRIBUTOR_GCN-LABEL: define {{[^@]+}}@take_addr_2
; ATTRIBUTOR_GCN-SAME: () #[[ATTR0]] {
; ATTRIBUTOR_GCN-NEXT:    ret ptr @callee2
;
  ret ptr @callee2
}

define amdgpu_kernel void @test_simple_indirect_call() {
; ATTRIBUTOR_GCN-LABEL: define {{[^@]+}}@test_simple_indirect_call
; ATTRIBUTOR_GCN-SAME: () #[[ATTR1:[0-9]+]] {
; ATTRIBUTOR_GCN-NEXT:    [[FP:%.*]] = load ptr, ptr @global_ptr, align 8
; ATTRIBUTOR_GCN-NEXT:    call void [[FP]]()
; ATTRIBUTOR_GCN-NEXT:    ret void
;
  %fp = load ptr, ptr @global_ptr
  call void %fp()
  ret void
}


!llvm.module.flags = !{!0}
!0 = !{i32 1, !"amdhsa_code_object_version", i32 500}
;.
; ATTRIBUTOR_GCN: attributes #[[ATTR0]] = { "amdgpu-no-agpr" "amdgpu-no-completion-action" "amdgpu-no-default-queue" "amdgpu-no-dispatch-id" "amdgpu-no-dispatch-ptr" "amdgpu-no-heap-ptr" "amdgpu-no-hostcall-ptr" "amdgpu-no-implicitarg-ptr" "amdgpu-no-lds-kernel-id" "amdgpu-no-multigrid-sync-arg" "amdgpu-no-queue-ptr" "amdgpu-no-workgroup-id-x" "amdgpu-no-workgroup-id-y" "amdgpu-no-workgroup-id-z" "amdgpu-no-workitem-id-x" "amdgpu-no-workitem-id-y" "amdgpu-no-workitem-id-z" "amdgpu-waves-per-eu"="4,10" "uniform-work-group-size"="false" }
; ATTRIBUTOR_GCN: attributes #[[ATTR1]] = { "uniform-work-group-size"="false" }
;.
; ATTRIBUTOR_GCN: [[META0:![0-9]+]] = !{i32 1, !"amdhsa_code_object_version", i32 500}
;.
